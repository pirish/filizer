<!DOCTYPE html>
<html>
<head>
    <title>Filizer Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .file-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 5px; }
        .duplicate-group { border: 2px solid red; padding: 10px; margin-bottom: 10px; }
        button { margin-left: 5px; }
    </style>
</head>
<body>
    <h1>Filizer Dashboard</h1>
    
    <div id="stats">
        <h2>Stats</h2>
        <p>Total Files: <span id="total-files">Loading...</span></p>
        <p>Total Size: <span id="total-size">Loading...</span> bytes</p>
    </div>

    <hr>

    <div id="search-section">
        <h2>Search</h2>
        <input type="text" id="search-input" placeholder="Search by name..." onkeypress="handleEnter(event)">
        <button onclick="searchFiles()">Search</button>
        <div id="file-list"></div>
    </div>

    <hr>

    <div id="reports-section">
        <h2>Duplicate Reports</h2>
        <button onclick="loadReports()">Load Duplicate Reports</button>
        <div id="reports-list"></div>
    </div>

    <script>
        const apiBase = '/api/v1';

        async function fetchFiles(query = {}) {
            const params = new URLSearchParams(query);
            const response = await fetch(`${apiBase}/files/?${params}`);
            return await response.json();
        }

        async function updateStats() {
            const response = await fetch(`${apiBase}/stats`);
            const stats = await response.json();
            document.getElementById('total-files').textContent = stats.total_files;
            document.getElementById('total-size').textContent = stats.total_size;
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                searchFiles();
            }
        }

        async function searchFiles() {
            const name = document.getElementById('search-input').value;
            const query = name ? { name: name } : {}; 
            const files = await fetchFiles(query);
            renderFiles(files);
        }

        function renderFiles(files) {
            const list = document.getElementById('file-list');
            list.innerHTML = '';
            if (files.length === 0) {
                list.innerHTML = '<p>No files found.</p>';
                return;
            }
            files.forEach(file => {
                const id = file.id || file._id;
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `
                    <strong>${file.name}</strong> (${file.size} bytes) <br>
                    Path: ${file.full_path} <br>
                    Action: ${file.action || 'None'} <br>
                    <button onclick="deleteFile('${id}')">Delete</button>
                    <button onclick="setAction('${id}')">Set Action</button>
                `;
                list.appendChild(div);
            });
        }

        async function deleteFile(id) {
            if(!confirm('Are you sure?')) return;
            const response = await fetch(`${apiBase}/files/${id}`, { method: 'DELETE' });
            if (response.ok) {
                searchFiles(); // Refresh
                updateStats();
                // If we are in reports view, we might want to refresh that too, 
                // but simpler to just reload reports if they are open.
                const reportsList = document.getElementById('reports-list');
                if (reportsList.innerHTML !== '') {
                    loadReports();
                }
            } else {
                alert('Failed to delete file');
            }
        }

        async function setAction(id) {
            const action = prompt('Enter action (e.g., delete, archive):');
            if(!action) return;
            const args = prompt('Enter action args (optional):');
            
            const response = await fetch(`${apiBase}/files/${id}/action`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, action_args: args })
            });
            if (response.ok) {
                searchFiles(); // Refresh
            } else {
                alert('Failed to set action');
            }
        }

        async function loadReports() {
            const response = await fetch('/reports');
            const data = await response.json();
            const list = document.getElementById('reports-list');
            list.innerHTML = '';
            
            // Render Duplicate Files
            list.innerHTML += '<h3>Duplicate Files</h3>';
            if (data.duplicate_files.length === 0) {
                list.innerHTML += '<p>No duplicate files found.</p>';
            } else {
                data.duplicate_files.forEach(group => {
                    const div = document.createElement('div');
                    div.className = 'duplicate-group';
                    div.innerHTML = `<h4>MD5: ${group._id} (Count: ${group.count})</h4>`;
                    
                    group.files.forEach(file => {
                         const id = file.id || file._id;
                         div.innerHTML += `
                            <div class="file-item">
                                <strong>${file.name}</strong> - ${file.full_path}
                                <button onclick="deleteFile('${id}')">Delete</button>
                            </div>
                         `;
                    });
                    list.appendChild(div);
                });
            }

            // Render Duplicate Directories
            list.innerHTML += '<h3>Duplicate Directories</h3>';
            if (data.duplicate_directories.length === 0) {
                list.innerHTML += '<p>No duplicate directories found.</p>';
            } else {
                data.duplicate_directories.forEach(group => {
                    const div = document.createElement('div');
                    div.className = 'duplicate-group';
                    div.innerHTML = `<h4>Directories: ${group.directories.join(', ')}</h4>`;
                    div.innerHTML += `<p>File Count: ${group.file_count}</p>`;
                    div.innerHTML += '<ul>';
                    group.files.forEach(file => {
                        div.innerHTML += `<li>${file.name} (MD5: ${file.md5})</li>`;
                    });
                    div.innerHTML += '</ul>';
                    list.appendChild(div);
                });
            }
        }

        // Initial load
        updateStats();
        searchFiles();

    </script>
</body>
</html>